const BACKEND_API_BASE_URL = '/api/payments';
        const params = new URLSearchParams(window.location.search);
        
        const orderData = {
            entryDate: params.get('entryDate'),
            entryTime: params.get('entryTime'),
            exitDate: params.get('exitDate'),
            exitTime: params.get('exitTime'),
            parkingType: params.get('parkingType'),
            insurance: params.get('insurance'),
            totalDays: params.get('totalDays'),
            totalPrice: parseFloat(params.get('totalPrice') || 0)
        };

        function formatarData(dataStr) {
            if (!dataStr) return '--/--/----';
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function atualizarInterface() {
            if (orderData.entryDate) document.getElementById('displayEntry').textContent = `${formatarData(orderData.entryDate)} ${orderData.entryTime || ''}`;
            if (orderData.exitDate) document.getElementById('displayExit').textContent = `${formatarData(orderData.exitDate)} ${orderData.exitTime || ''}`;
            document.getElementById('displayParking').textContent = orderData.parkingType === 'covered' ? 'Coberta' : 'Descoberta';
            document.getElementById('displayInsurance').textContent = orderData.insurance === 'true' ? 'Sim' : 'Não';
            document.getElementById('displayDays').textContent = orderData.totalDays || '0';
            
            const precoFormatado = `R$ ${orderData.totalPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('displayTotal').textContent = precoFormatado;
            document.getElementById('mobileTotalPrice').textContent = precoFormatado;
        }

        // Máscaras
        document.getElementById('cpf').addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '');
            v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = v;
        });

        document.getElementById('phone').addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '');
            v = v.replace(/^(\d{2})(\d)/g, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2');
            e.target.value = v;
        });

        // Envio do Formulário e Integração API
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            
            if (submitBtn.textContent === 'Já Paguei') {
                window.location.href = 'https://statusdopedido.manus.space/';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('btn-loading');
            document.getElementById('loadingOverlay').style.display = 'flex';

            const formData = new FormData(this);
            
            // PAYLOAD AJUSTADO PARA O FORMATO EXATO DO CÓDIGO ORIGINAL (PAYEVO)
            const pixData = {
                paymentMethod: 'PIX',
                amount: Math.round(orderData.totalPrice * 100), // Converte para centavos
                customer: {
                    name: formData.get('fullName'), // Nome completo
                    email: formData.get('email'),
                    phone: formData.get('phone').replace(/\D/g, ''),
                    document: {
                        number: formData.get('cpf').replace(/\D/g, ''),
                        type: 'CPF'
                    }
                },
                items: [{
                    title: `Reserva GuaruPark - ${orderData.totalDays} diárias`,
                    quantity: 1,
                    price: Math.round(orderData.totalPrice * 100)
                }],
                pix: {
                    expiresIn: 3600 // Expira em 1 hora
                },
                // Metadados adicionais (opcional, se o backend aceitar)
                metadata: {
                    plate: formData.get('plate').toUpperCase(),
                    vehicleType: formData.get('vehicleType'),
                    entry: `${orderData.entryDate} ${orderData.entryTime}`,
                    exit: `${orderData.exitDate} ${orderData.exitTime}`
                }
            };

            try {
                const response = await fetch(`${BACKEND_API_BASE_URL}/pix`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pixData)
                });

                const result = await response.json();

                if (response.ok) {
                    // O código original espera result.pix.qrcode
                    if (result.pix && result.pix.qrcode) {
                        showPixDetails(result.pix.qrcode);
                    } else {
                        throw new Error('Resposta da API sem código PIX');
                    }
                } else {
                    const errorMsg = result.error || result.message || 'Erro na API PayEvo';
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('Erro ao gerar PIX:', error);
                alert('Erro: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-loading');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });

        function showPixDetails(qrcode) {
            document.getElementById('pixPaymentDetails').style.display = 'block';
            document.getElementById('pixCodeText').textContent = qrcode;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Já Paguei';
            submitBtn.style.backgroundColor = '#10b981';
            
            startTimer(900);
            window.scrollTo({ top: document.getElementById('pixPaymentDetails').offsetTop - 20, behavior: 'smooth' });
        }

        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            const display = document.getElementById('pixTimeRemaining');
            const interval = setInterval(() => {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (--timer < 0) clearInterval(interval);
            }, 1000);
        }

        function copyPixCode() {
            const code = document.getElementById('pixCodeText').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('pixCopyButton');
                btn.textContent = 'Copiado!';
                setTimeout(() => btn.textContent = 'Copiar Código', 2000);
            });
        }

        document.addEventListener('DOMContentLoaded', atualizarInterface);
